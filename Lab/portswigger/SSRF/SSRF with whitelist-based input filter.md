# Lab: SSRF with whitelist-based input filter
* Bắt đầu với lab bắt chúng ta phải bypass qua được whitelist vì lab này sử dụng whitelist nên chỉ cho phép chúng ta sẽ input những keyword có trong whitelist.
* Lab này có Endpoit vẫn như 3 lab trước là stockApi.
* Khi mà chúng ta thay đổi url thành localhost thì nhận phản hồi host phải stock.weliketoshop.net
![image](https://user-images.githubusercontent.com/20487674/124730774-d7b59c00-df3b-11eb-885e-745987ae8c30.png)
* Tiếp tục thử fuzzing tiếp thêm ký tự @ để chuyển localhost là phần authority còn trong stock.weliketoshop.net phần host payload kết quả nhận phản hồi 200 OK 
![image](https://user-images.githubusercontent.com/20487674/124731177-324ef800-df3c-11eb-8c68-11038210b451.png)
![image](https://user-images.githubusercontent.com/20487674/124731246-3f6be700-df3c-11eb-9765-828c319383b9.png)
* Thử tạo http://localhost@owasp.org/ bỏ lên thanh địa chỉ trình duyệt web thì load đến trang owasp.org vẫn payload trên cũng hoạt động như vậy
* Nói rõ hơn một tý về cấu trúc URI theo chuẩn  RFC 3986 thì gồm 5 phần scheme (protocol), authority (nhà cung cấp), path (đường dẫn), query (truy vấn) và fragment (định các mục dữ liệu ở web).[Đọc thêm URI ](https://vi.wikipedia.org/wiki/URI)
* ![image](https://user-images.githubusercontent.com/20487674/124732971-ef8e1f80-df3d-11eb-9f27-1a0efef48207.png)
* Tiếp theo sẽ thử tiếp http://localhost stock.weliketoshop.net:8080/admin
![image](https://user-images.githubusercontent.com/20487674/124733550-7f33ce00-df3e-11eb-8adb-79e3b9e36be5.png)
* Sau khi dựa vào phản hồi ,bắt đầu search google thử dựa vào phản hồi đó thì phía backend được viết bằng java và thực hiện URL-parsing(phân tích url)
* Tiếp tục search google tiếp ssrf url parse thì có một bài viết khá hay nói về việc xử lý phân tích url bằng module , function của các ngôn ngữ
* [A New Era of SSRF - Exploiting URL Parser in Trending Programming Languages!](https://www.blackhat.com/docs/us-17/thursday/us-17-Tsai-A-New-Era-Of-SSRF-Exploiting-URL-Parser-In-Trending-Programming-Languages.pdf)
* Sau khi đọc xong thì do không có sự thống nhất trong việc phần tích url giữa các module , function url-parse và việc gửi request.Cũng như các url bị có các ký tự bị encode dễ đến
việc phân tích url không được chính xác.
* Tiếp thử payload http://localhost?@stock.weliketoshop.net:8080/admin  thì nhận phản hồi host phải stock.weliketoshop.net
* ![image](https://user-images.githubusercontent.com/20487674/124735333-28c78f00-df40-11eb-8747-ab3c42a37c02.png)
* Trước hết tại sao mình lại dùng payload như vậy mà bị phản hồi host phải stock.weliketoshop.net do theo chuẩn RFC 3986,
thì phần authority sẽ bắt đầu dấu // và kết thúc bằng 1 một trong các dấu / , ? , # khi ta nhập payload trên trình duyệt web sẽ đến localhost chứ không phải là stock.weliketoshop.net:8080 , sau khi load xong thì http://localhost?@stock.weliketoshop.net:8080/admin thay đổi http://localhost/?@stock.weliketoshop.net:8080/admin
![image](https://user-images.githubusercontent.com/20487674/124736793-8c05f100-df41-11eb-8206-0022db3812a2.png)
* Danh sách các ký tự không bị giới hạn sẽ không bị encode url và các ký tự bị giới hạn sẽ bị encode url
![image](https://user-images.githubusercontent.com/20487674/124737313-08003900-df42-11eb-81c2-817c3add3fe9.png)
* Mình sẽ mã hóa dấu ? = > %3f => %25%33%66 
* Thử tiếp payload http://localhost%3f@stock.weliketoshop.net:8080/admin
* ![image](https://user-images.githubusercontent.com/20487674/124738411-1a2ea700-df43-11eb-9abe-2a4874c53d31.png)
* Có nhắc ở trên khi url encode thì các module ,function url parse khi phân tích sẽ không chính xác
* Đoạn code sự khác nhau , sau phân tích url đã encode và url đã decode 1 lần 
![image](https://user-images.githubusercontent.com/20487674/124739417-0a639280-df44-11eb-9955-f85f16b5a3a0.png)
* Thử payload có dấu ? sau khi double encode url http%3A%2F%2Flocalhost%25%33%66@stock.weliketoshop.net%3A8080%2Fadmin thì ok load vào trang admin
 ![image](https://user-images.githubusercontent.com/20487674/124740292-d9d02880-df44-11eb-9dea-81285354ba2b.png)
* Xem tiếp đoạn code sự khác nhau , sau phân tích url đã encode và url đã decode 1 lần,url đã decode 2 lần
![image](https://user-images.githubusercontent.com/20487674/124740589-2287e180-df45-11eb-9bb8-71345a47a3db.png)
* Có lẽ là do vấn đề mà trong phần lý thuyết của portswigger có đề cập đến bởi kết quả khác nhau bộ lọc các ký tự bị mã hóa và gửi request ở phía backend không được thống nhất
* Tới đây sử dụng payload mà dấu ? đã double encode url xóa user carlos http%3A%2F%2Flocalhost%25%33%66@stock.weliketoshop.net%3A8080%2Fadmin%2fdelete%3fusername=carlos
* Theo mình bài lab này khá hay trong quá trình làm mình đã có thêm những kiến thức mới
![image](https://user-images.githubusercontent.com/20487674/124742561-0c7b2080-df47-11eb-90a3-c59cdc4df769.png)









